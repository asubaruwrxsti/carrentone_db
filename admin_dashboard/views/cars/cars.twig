<link rel="stylesheet" href="/admin_dashboard/views/cars/cars.css">
<div class="container">
    <a href="/admin_dashboard/index.php/cars/add/" class="btn btn-primary mt-3"><span class="fas fa-plus"></span>&nbsp;Add Car</a>
    <div class="row">
        <div class="row mt-4 restrict-height" id="main-car-container">
            {% for car in cars %}
                <div class="col-lg-5 mt-3 car-cards">
                    <div class="card h-100 p-3 container-fluid">
                        <div class="overflow-hidden position-relative border-radius-lg bg-cover h-100 car-image" id="car-{{car.id}}" style="background-image: linear-gradient(to bottom left, rgba(0,0,0,0), rgba(0,0,0,1)), url('{{car.image[0]}}'); background-position: center bottom ;">
                            <span class="mask bg-gradient-dark"></span>
                            <div class="card-body position-relative z-index-0 d-flex flex-column h-100 p-3">
                                <h5 class="text-white font-weight-bolder mb-4 pt-2">{{car.name}}</h5>
                                <p class="text-white">{{car.description}}</p>
                                <a class="text-white text-sm font-weight-bold mb-0 icon-move-right mt-auto view-link" href="#" onclick="showDetails({{car.id}})">
                                    View
                                <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="details" style="display: none;">
            <div id="mainDetailCard" class="card detail-container d-flex fade-slide-in" style="transform: translateX(-200px); position: fixed;">
                <div class="card-body p-3">
                    <div class="row" id="details" style="display: none;">
                        <div class="col">
                            <div class="row">
                                <div class="col-lg-6 col-12">
                                    <img class="w-100 border-radius-lg" id="car-image">
                                </div>
                                <div class="col-lg-4">
                                    <table class="table">
                                        <tr>
                                            <td colspan="2">
                                                <div class="d-flex flex-column">
                                                    <h6 class="mb-1 font-weight-bold text-sm">Name: <span id="carTitle"></span></h6>
                                                    <h6 class="mb-1 font-weight-bold text-sm">Price: <span id="carPrice"></span></h6>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2">
                                                <div class="d-flex flex-column">
                                                    <label class="mb-1 font-weight-bold text-sm" for="carDescription">Description: </label>
                                                    <span class="text-xs padding-left" id="carDescription"></span>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <label class="mb-1 font-weight-bold text-sm" for="carCount">Order Count: </label>
                                                    <span class="text-xs padding-left" id="carCount"></span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <label class="mb-1 font-weight-bold text-sm" for="carCreated">Created at: </label>
                                                    <span class="text-xs padding-left" id="carCreated"></span>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div class="row mt-5">
                                <div class="col mt-3">
                                    <div class="card" style="height: 8rem; width: 18rem;">
                                        <div class="card-body">
                                            <h5 class="card-title">Total Revenue</h5>
                                            <div id="loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="sr-only"></span>
                                                </div>
                                            </div>
                                            <div id="revenueDependencies" style="display: none; align-items: center;">
                                                <h3 id="revenueTotal"></h3>
                                                <h5 style="margin-left: 10px">{{currency}}</h5>
                                                <span id="revenueGrowth" class="text-sm font-weight-bolder" style="margin-left: auto; color: lightgreen"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col mt-3">
                                    <span id="isAvailable" class="badge badge-sm bg-gradient-primary mt-2" style="font-size: 10px;"></span>
                                    <span id="carTransmission" class="badge badge-sm bg-gradient-primary mt-2" style="font-size: 10px;"></span>
                                    <span id="carTravelDistance" class="badge badge-sm bg-gradient-primary mt-2" style="font-size: 10px;"></span>
                                    <div class="row mt-5">
                                        <div class="d-flex flex-column col">
                                            <label class="mb-1 font-weight-bold text-sm" for="carNextOrder">Next Order: </label>
                                            <span class="text-xs padding-left" id="carNextOrder"></span>
                                        </div>
                                        <div class="d-flex flex-column col">
                                            <a class="text-sm font-weight-bold mb-0 icon-move-right ms-auto view-link" id="editCar" href="#">
                                                <button class="btn btn-primary btn-sm">Edit <i class="fas fa-arrow-right ms-1" aria-hidden="true"></i></button>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/admin_dashboard/views/cars/cars.js"></script>
<script>
    let Car = new Cars();
    let currentLayout = "row";
    
    const carCards = document.querySelectorAll('.car-cards');
    const mainCarContainer = document.getElementById('main-car-container');
    const detailsCard = document.querySelectorAll('#details')[0];
    const detailsBody = document.querySelectorAll('#details')[1];
    const carImage = document.getElementById('car-image');

    function changeLayout() {
        if (currentLayout == "col") return;
        else currentLayout = "col";

        var fadeEffect = setInterval(function () {
            if (!mainCarContainer.style.opacity) {
                mainCarContainer.style.opacity = 1;
            }
            if (mainCarContainer.style.opacity > 0) {
                mainCarContainer.style.opacity -= 0.1;
            } else {
                clearInterval(fadeEffect);
            }
        }, 10);

        setTimeout(function () {
            mainCarContainer.classList.remove('row');
            mainCarContainer.classList.add('col');
            mainCarContainer.classList.add('restrict-height');

            if (!mainCarContainer.style.opacity) {
                mainCarContainer.style.opacity = 0;
            }
            var fadeEffect = setInterval(function () {
                if (mainCarContainer.style.opacity < 1) {
                    mainCarContainer.style.opacity = parseFloat(mainCarContainer.style.opacity) + 0.1;
                } else {
                    clearInterval(fadeEffect);
                }
            }, 10);

            carCards.forEach(function (card) {
                card.classList.remove('col-lg-5');
                card.classList.add('col-lg-7');
            });
            detailsCard.classList.add('col-lg-4');
            detailsCard.classList.add('mt-5');
            detailsCard.style.display = 'block';
        }, 200);
    }

    function showDetails(id) {
        changeLayout();
        event.preventDefault();

        let mainDetailCard = document.getElementById('mainDetailCard');
        mainDetailCard.style.backgroundImage = 'none';

        Car.getCarById(id).then(function (car) {
            if (detailsBody.style.display != 'block') detailsBody.style.display = 'block';

            document.getElementById('carTitle').innerHTML = car[0].name;
            document.getElementById('carDescription').innerHTML = car[0].description;
            document.getElementById('carPrice').innerHTML = car[0].price + " {{currency}}";
            document.getElementById('carCount').innerHTML = car[0].order_count + " time (s)";
            document.getElementById('carCreated').innerHTML = car[0].created_at;
            document.getElementById('carTransmission').innerHTML = (car[0].transmission == 0) ? "Automatic" : "Manual";
            document.getElementById('carTravelDistance').innerHTML = (car[0].travel_distance.trim().length == 0) ? "0 Km" : car[0].travel_distance;
            
            // BACKLOG: Fix this
            //document.getElementById('carNextOrder').innerHTML = (car[0].next_order != 'NULL') ? "None Ahead" : car[0].next_order;
            Car.hasNextOrder(id).then(function (hasNextOrder) {
                if (!hasNextOrder) {
                    document.getElementById('carNextOrder').innerHTML = "None Ahead";
                } else {
                    document.getElementById('carNextOrder').innerHTML = new Date(hasNextOrder).toLocaleDateString('en-GB');
                }
            });
            document.getElementById('editCar').href = `/admin_dashboard/index.php/cars/edit/${id}`;

            var bg = document.getElementById('car-' + id).style.backgroundImage;
            bg = bg.split('url(')[1];
            bg = bg.slice(0, -1);
            bg = bg.replace(/['"]+/g, '');

            carImage.src = bg;
        });

        Car.getRevenueById(id).then(function (revenue) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('revenueDependencies').style.display = 'flex';
            document.getElementById('revenueTotal').innerHTML = revenue.revenue;
        
            if (parseFloat(revenue.growRate) > 0) {
                document.getElementById('revenueGrowth').innerHTML = '&#9650;' + revenue.growRate + '%';
                document.getElementById('revenueGrowth').style.color = 'lightgreen';
            } else if (parseFloat(revenue.growRate) == 0) {
                document.getElementById('revenueGrowth').innerHTML = '&#61; ' + revenue.growRate + '%';
                document.getElementById('revenueGrowth').style.color = 'gold';
            } else {
                document.getElementById('revenueGrowth').innerHTML = '&#9660;' + revenue.growRate + '%';
                document.getElementById('revenueGrowth').style.color = 'lightcoral';
            }
        });

        Car.calculateIsAvailable(id).then(function (availability) {
            if (availability) {
                document.getElementById('isAvailable').innerHTML = 'Available';
                document.getElementById('isAvailable').classList.remove('bg-gradient-danger');
                document.getElementById('isAvailable').classList.add('bg-gradient-success');
            } else {
                document.getElementById('isAvailable').innerHTML = 'Not Available';
                document.getElementById('isAvailable').classList.remove('bg-gradient-success');
                document.getElementById('isAvailable').classList.add('bg-gradient-danger');
            }
        });
    }
</script>
<link rel="stylesheet" href="/admin_dashboard/views/orders/orders.css">

<div class="nav nav-tabs col-lg-12 justify-content-center" role="tablist">
    <button class="nav-link" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">All Cars</button>
    <button class="nav-link" id="nav-shopping-tab" data-bs-toggle="tab" data-bs-target="#nav-shopping" role="tab" aria-controls="nav-shopping" aria-selected="false">Search Agenda</button>
</div>
<div id="calendar"></div>

<script>
    $("#calendar").evoCalendar({
        'eventDisplayDefault': false,
        'sidebarDisplayDefault': false,
        'format': 'MM dd, yyyy',
        'todayHighlight': false
    });

    function generateUniqueColor(id) {
        var hue = (id * 137.508) % 360;
        var color = 'hsl(' + hue + ', 70%, 60%)';
        return color;
    }

    let orders = [
        {% for order in orders %}
            {
            orderId: '{{ order.id }}',
            renterName: '{{ order.firstname }} {{ order.lastname }}',
            car: '{{ order.name }}',
            startDate: '{{ order.rental_date|date("M d, Y") }}',
            endDate: '{{ order.rental_date|date_modify('+' ~ order.rental_duration ~ ' days')|date('M d, Y') }}',
            }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

function doesOverlap(date) {
  var dateObj = new Date(date);

  // Use Array.prototype.filter() to get all overlapping orders
  var overlappingOrders = orders.filter(order => {
    var startDate = new Date(order.startDate);
    var endDate = new Date(order.endDate);
    return dateObj >= startDate && dateObj <= endDate;
  });

  if (overlappingOrders.length > 0) {
    // Return an array with true and the color
    return overlappingOrders.map(order => generateUniqueColor(order.orderId));
  } else {
    return [false, ''];
  }
}



    orders.forEach(order => {
        $("#calendar").evoCalendar('addCalendarEvent', [
            {
                id: order.orderId,
                name: order.renterName,
                type: 'Rental',
                date: order.startDate,
                color: generateUniqueColor(order.orderId)
            }
        ]);
    });

    function generateView() {
        document.querySelectorAll('.calendar-day').forEach(item => {
            let div = item.querySelector('div');
            let date = new Date(div.getAttribute('data-date-val'));

            orders.forEach(order => {
                let startDate = new Date(order.startDate);
                let endDate = new Date(order.endDate);
                
                if (date >= startDate && date <= endDate) {

                    if (endDate.getTime() == startDate.getTime()) {
                        item.style.backgroundColor = generateUniqueColor(order.orderId);
                        item.style.boxShadow = '0 0 10px ' + generateUniqueColor(order.orderId);
                        div.style.color = 'white';
                        item.style.borderRadius = '20px 20px 20px 20px';
                        return;
                    }

                    item.style.backgroundColor = generateUniqueColor(order.orderId);
                    item.style.boxShadow = '0 0 10px ' + generateUniqueColor(order.orderId);
                    div.style.color = 'white';

                    //background-color: #e5e5f7;
                    //opacity: 0.8;
                    //background: repeating-linear-gradient( 45deg, #444cf7, #444cf7 5px, #e5e5f7 5px, #e5e5f7 25px );

                    if (date.getTime() == startDate.getTime()) {
                        item.style.borderRadius = '20px 0 0 20px';
                    } else if (date.getTime() == endDate.getTime()) {
                        item.style.borderRadius = '0 20px 20px 0';
                    } else {
                        item.style.borderRadius = '0';
                    }

                    let overlappingOrders = doesOverlap(div.getAttribute('data-date-val'));

                    if (overlappingOrders.length > 0) {
                    console.log(overlappingOrders);
                    let gradientColors = overlappingOrders.join(', ');

                    item.style.backgroundColor = overlappingOrders[0];
                    item.style.background = 'repeating-linear-gradient(45deg, ' + gradientColors + ' 0px, transparent 15px)';
                    
                    let date = new Date(div.getAttribute('data-date-val'));
                    let endDate = new Date(div.getAttribute('data-end-date-val'));
                    
                    if (date.getTime() == endDate.getTime()) {
                        item.style.borderRadius = '0';
                    }
                    }

                }
            });
        });
    }

    generateView();
    $('#calendar').on('selectMonth', function(event, newDate, oldDate) {
        generateView();
    });

</script>
<link rel="stylesheet" href="/admin_dashboard/views/orders/orders.css">
<script src="/admin_dashboard/views/orders/orders.js"></script>
<a class="text-sm font-weight-bold mb-0 icon-move-left ms-auto view-link" href="/admin_dashboard/index.php/orders">
    <button class="btn btn-primary btn-sm" id="editCar"><i class="fas fa-arrow-left text-sm ms-1" aria-hidden="true"></i>&nbsp;Back</button>
</a>

<div class="container-fluid card mt-3">
    <form>
        <div class="row" class="formContainer">
            <div class="col-lg-12 mb-3">
                <div class="new_property_form">
                    <h4 class="title mt-5">Order Details</h4>
                    <div class="row">
                        <div class="col">
                            <div class="form">
                                <label class="form-label">Customer</label>
                                <input name="form_name" id="autoCompleteCustomers" class="form-control" type="text" placeholder="Customer" required>
                                <span style="display: none" class="form-text fade-in mt-2" id="customerMessage"></span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form">
                                <label class="form-label">Car</label>
                                <input name="form_name" id="autoCompleteCar" class="form-control" type="text" placeholder="Car" required>
                                <span style="display: none" class="form-text fade-in mt-2" id="carMessage"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-5">
                        <div class="col">
                            <div class="form">
                                <label class="form-label">Start Date</label>
                                <input name="form_name" id="orderStartDate" class="form-control" type="date" required>
                                <span style="display: none" class="form-text fade-in mt-2" id="startDateMessage"></span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form">
                                <label class="form-label">End Date</label>
                                <input name="form_name" id="orderEndDate" class="form-control" type="date" required>
                                <span style="display: none" class="form-text fade-in mt-2" id="endDateMessage"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		<div class="row mt-2">
			<div class="col">
				<div class="form">
					{# BACKLOG: add order notes #}
					<label class="form-label">Notes (optional)</label>
					<input name="form_name" id="orderNotes" class="form-control" type="text" placeholder="Notes">
				</div>
			</div>
		</div>
		<div class="row mt-5">
			<div class="col">
				<div class="form">
					{# BACKLOG: make add order functional #}
					{# BACKLOG: ask user if he wants to create user if not exists #}
					<button type="button" class="btn btn-primary btn-sm" id="addOrder">Add Order</button>
				</div>
			</div>
		</div>
    </form>
</div>

<script>
    let orders = new Orders();
    let orderStartDate = document.getElementById("orderStartDate");
    let orderEndDate = document.getElementById("orderEndDate");

    let orderStartDateMessage = document.getElementById("startDateMessage");
    let orderEndDateMessage = document.getElementById("endDateMessage");
    let customerMessage = document.getElementById("customerMessage");
    let carMessage = document.getElementById("carMessage");

    orderEndDate.addEventListener("change", function() {
        if (orderStartDate.value != "" && orderEndDate.value != "" && new Date(orderStartDate.value).setHours(0, 0, 0, 0) > new Date(orderEndDate.value).setHours(0, 0, 0, 0)) {
            document.getElementById("startDateMessage").innerHTML = "Start date must be before end date";
            document.getElementById("startDateMessage").style.color = "red";
            document.getElementById("startDateMessage").style.display = "block";
        } else {
            document.getElementById("startDateMessage").innerHTML = "";
            document.getElementById("startDateMessage").style.display = "none";
        }
    })

    let customers = [
        {% for customer in customers %}
            {
                "name": "{{ customer.firstname }} {{ customer.lastname }}",
                "id": "{{ customer.id }}",
            } {% if not loop.last %},{% endif %}
        {% endfor %}
    ]

    let cars = [
        {% for car in cars %}
            {
                "name": "{{ car.name }}",
                "data": {
                    "id": "{{ car.id }}",
                    "price": "{{ car.price }}",
                }
            } {% if not loop.last %},{% endif %}
        {% endfor %}
    ]

    const autoCompleteCustomers = new autoComplete({
        selector: "#autoCompleteCustomers",
        data: {
            src: customers,
            keys: ["name"],
        },
        resultsList: {
            element: (list, data) => {
				console.log(data.results.length);
                if (!data.results.length) {
                    customerMessage.style.display = "block";
					customerMessage.innerHTML = "Customer doesnt exist!";
					customerMessage.style.color = "red";
				} else {
					customerMessage.innerHTML = "";
					customerMessage.style.display = "none";
                }
            },
			noResults: true,
        },
        events: {
            input: {
                selection: (event) => {
                    const selectionCustomer = event.detail.selection.value.name;
                    autoCompleteCustomers.input.value = selectionCustomer;
                },
            },
        },
    });

    const autoCompleteCars = new autoComplete({
        selector: "#autoCompleteCar",
        data: {
            src: cars,
            keys: ["name"],
            cache: false,
        },
        resultsList: {
            element: (list, data) => {
                if (!data.results.length) {
						carMessage.style.display = "block";
						carMessage.innerHTML = "Car doesnt exist!";
						carMessage.style.color = "red";
				} else {
					carMessage.innerHTML = "";
					carMessage.style.display = "none";
                }
            },
            noResults: true,
        },
        events: {
            input: {
                selection: (event) => {
					const selectionCar = event.detail.selection.value.name;
					autoCompleteCars.input.value = selectionCar;
                },
            },
        },
    });
</script>